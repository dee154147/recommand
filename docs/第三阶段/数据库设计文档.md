# 第三阶段数据库设计文档

## 数据库概述
第三阶段主要涉及用户交互数据的存储和管理，需要设计相应的数据表来支持用户交互、推荐算法和数据分析功能。

## 数据表设计

### 1. 用户表 (users)
存储用户基本信息和偏好数据

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    avatar VARCHAR(200),
    preferences JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `id`: 用户唯一标识
- `username`: 用户名
- `email`: 邮箱地址
- `avatar`: 头像URL
- `preferences`: 用户偏好设置（JSON格式）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2. 商品表 (products)
存储商品基本信息和特征数据

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2),
    category VARCHAR(100),
    tags TEXT[],
    image_url VARCHAR(500),
    features JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**字段说明：**
- `id`: 商品唯一标识
- `name`: 商品名称
- `description`: 商品描述
- `price`: 商品价格
- `category`: 商品分类
- `tags`: 商品标签数组
- `image_url`: 商品图片URL
- `features`: 商品特征数据（JSON格式）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 3. 用户交互表 (user_interactions)
记录用户与商品的交互行为

```sql
CREATE TABLE user_interactions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    interaction_type VARCHAR(20) NOT NULL,
    score INTEGER NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_id VARCHAR(100),
    metadata JSONB
);
```

**字段说明：**
- `id`: 交互记录唯一标识
- `user_id`: 用户ID（外键）
- `product_id`: 商品ID（外键）
- `interaction_type`: 交互类型（click, view, favorite, purchase, dislike）
- `score`: 交互评分
- `timestamp`: 交互时间
- `session_id`: 会话ID
- `metadata`: 额外元数据（JSON格式）

**交互类型和评分规则：**
- `click`: 点击行为，评分 +1
- `view`: 查看行为，评分 +2
- `favorite`: 收藏行为，评分 +3
- `purchase`: 购买行为，评分 +5
- `dislike`: 不推荐行为，评分 -2

### 4. 推荐记录表 (recommendations)
记录推荐算法的推荐结果

```sql
CREATE TABLE recommendations (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    recommendation_score DECIMAL(5,4),
    algorithm_type VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP
);
```

**字段说明：**
- `id`: 推荐记录唯一标识
- `user_id`: 用户ID（外键）
- `product_id`: 商品ID（外键）
- `recommendation_score`: 推荐分数（0-1之间）
- `algorithm_type`: 推荐算法类型
- `created_at`: 创建时间
- `expires_at`: 过期时间

### 5. 用户会话表 (user_sessions)
记录用户会话信息

```sql
CREATE TABLE user_sessions (
    id VARCHAR(100) PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);
```

**字段说明：**
- `id`: 会话唯一标识
- `user_id`: 用户ID（外键）
- `ip_address`: IP地址
- `user_agent`: 用户代理信息
- `created_at`: 创建时间
- `last_activity`: 最后活动时间
- `is_active`: 是否活跃

## 索引设计

### 1. 用户交互表索引
```sql
-- 用户交互查询索引
CREATE INDEX idx_user_interactions_user_id ON user_interactions(user_id);
CREATE INDEX idx_user_interactions_product_id ON user_interactions(product_id);
CREATE INDEX idx_user_interactions_timestamp ON user_interactions(timestamp);
CREATE INDEX idx_user_interactions_type ON user_interactions(interaction_type);

-- 复合索引：用户+时间
CREATE INDEX idx_user_interactions_user_time ON user_interactions(user_id, timestamp DESC);

-- 复合索引：商品+时间
CREATE INDEX idx_user_interactions_product_time ON user_interactions(product_id, timestamp DESC);
```

### 2. 推荐记录表索引
```sql
-- 推荐查询索引
CREATE INDEX idx_recommendations_user_id ON recommendations(user_id);
CREATE INDEX idx_recommendations_score ON recommendations(recommendation_score DESC);
CREATE INDEX idx_recommendations_created_at ON recommendations(created_at DESC);

-- 复合索引：用户+分数
CREATE INDEX idx_recommendations_user_score ON recommendations(user_id, recommendation_score DESC);
```

### 3. 商品表索引
```sql
-- 商品搜索索引
CREATE INDEX idx_products_name ON products USING gin(to_tsvector('chinese', name));
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_tags ON products USING gin(tags);
CREATE INDEX idx_products_price ON products(price);
```

## 数据关系图

```
users (1) -----> (N) user_interactions (N) <----- (1) products
  |                                                    |
  |                                                    |
  v                                                    v
user_sessions                                    recommendations
  |                                                    |
  v                                                    v
(1) -----> (N) recommendations (N) <----- (1) products
```

## 数据统计视图

### 1. 用户交互统计视图
```sql
CREATE VIEW user_interaction_stats AS
SELECT 
    u.id as user_id,
    u.username,
    COUNT(ui.id) as total_interactions,
    SUM(ui.score) as total_score,
    AVG(ui.score) as average_score,
    COUNT(DISTINCT ui.product_id) as unique_products,
    MAX(ui.timestamp) as last_interaction
FROM users u
LEFT JOIN user_interactions ui ON u.id = ui.user_id
GROUP BY u.id, u.username;
```

### 2. 商品热度统计视图
```sql
CREATE VIEW product_popularity_stats AS
SELECT 
    p.id as product_id,
    p.name,
    COUNT(ui.id) as total_interactions,
    SUM(ui.score) as total_score,
    AVG(ui.score) as average_score,
    COUNT(DISTINCT ui.user_id) as unique_users,
    MAX(ui.timestamp) as last_interaction
FROM products p
LEFT JOIN user_interactions ui ON p.id = ui.product_id
GROUP BY p.id, p.name;
```

## 数据迁移脚本

### 1. 创建表结构
```sql
-- 创建用户表
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE,
    avatar VARCHAR(200),
    preferences JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建商品表
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2),
    category VARCHAR(100),
    tags TEXT[],
    image_url VARCHAR(500),
    features JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建用户交互表
CREATE TABLE user_interactions (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    interaction_type VARCHAR(20) NOT NULL,
    score INTEGER NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    session_id VARCHAR(100),
    metadata JSONB
);

-- 创建推荐记录表
CREATE TABLE recommendations (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    recommendation_score DECIMAL(5,4),
    algorithm_type VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP
);

-- 创建用户会话表
CREATE TABLE user_sessions (
    id VARCHAR(100) PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE
);
```

### 2. 创建索引
```sql
-- 用户交互表索引
CREATE INDEX idx_user_interactions_user_id ON user_interactions(user_id);
CREATE INDEX idx_user_interactions_product_id ON user_interactions(product_id);
CREATE INDEX idx_user_interactions_timestamp ON user_interactions(timestamp);
CREATE INDEX idx_user_interactions_type ON user_interactions(interaction_type);
CREATE INDEX idx_user_interactions_user_time ON user_interactions(user_id, timestamp DESC);
CREATE INDEX idx_user_interactions_product_time ON user_interactions(product_id, timestamp DESC);

-- 推荐记录表索引
CREATE INDEX idx_recommendations_user_id ON recommendations(user_id);
CREATE INDEX idx_recommendations_score ON recommendations(recommendation_score DESC);
CREATE INDEX idx_recommendations_created_at ON recommendations(created_at DESC);
CREATE INDEX idx_recommendations_user_score ON recommendations(user_id, recommendation_score DESC);

-- 商品表索引
CREATE INDEX idx_products_name ON products USING gin(to_tsvector('chinese', name));
CREATE INDEX idx_products_category ON products(category);
CREATE INDEX idx_products_tags ON products USING gin(tags);
CREATE INDEX idx_products_price ON products(price);
```

## 数据维护策略

### 1. 数据清理
- 定期清理过期的推荐记录
- 清理无效的用户会话
- 清理测试数据

### 2. 数据备份
- 每日自动备份用户交互数据
- 定期备份商品数据
- 备份推荐算法结果

### 3. 性能优化
- 定期分析查询性能
- 优化慢查询
- 更新统计信息
