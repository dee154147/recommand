# 系统还原指南

## 📋 还原前提条件

### **已备份组件**
- ✅ **代码**: Git仓库已提交推送到远程仓库
- ✅ **数据库**: PostgreSQL备份文件 (596MB)

### **需要重新获取的组件**
- 🔄 **词向量模型**: 需要重新下载或获取
- 🔄 **原始数据**: 需要重新准备
- 🔄 **依赖包**: 通过包管理器重新安装

## 🚀 系统还原步骤

### **1. 获取代码**
```bash
# 克隆代码仓库
git clone <repository-url>
cd recommand2

# 切换到最新版本
git checkout main
git pull origin main
```

### **2. 环境准备**

#### **2.1 安装Python依赖**
```bash
# 安装Python包
pip install -r requirements.txt
```

#### **2.2 安装Node.js依赖**
```bash
# 进入前端目录
cd frontend

# 安装前端依赖
npm install
```

#### **2.3 安装PostgreSQL和pgvector**
```bash
# macOS (使用Homebrew)
brew install postgresql
brew install pgvector

# 启动PostgreSQL服务
brew services start postgresql
```

### **3. 数据库还原**

#### **3.1 创建数据库**
```bash
# 创建数据库
createdb -h localhost -U $(whoami) recommendation_db
```

#### **3.2 还原数据**

**方式A: 使用自定义格式备份 (推荐)**
```bash
# 还原数据库
pg_restore -h localhost -U $(whoami) -d recommendation_db \
  --verbose --clean --if-exists \
  backups/recommendation_db_backup_20250915_215036.dump
```

**方式B: 使用SQL格式备份**
```bash
# 还原数据库
psql -h localhost -U $(whoami) -d recommendation_db \
  -f backups/recommendation_db_backup_20250915_215124.sql
```

### **4. 获取词向量模型**

#### **4.1 下载腾讯AI Lab中文词向量**
- **模型文件**: `Tencent_AILab_ChineseEmbedding.bin`
- **向量文件**: `Tencent_AILab_ChineseEmbedding.bin.vectors.npy`
- **总大小**: 约9.6GB
- **下载地址**: 需要从腾讯AI Lab官网获取

#### **4.2 放置模型文件**
```bash
# 创建模型目录
mkdir -p model/

# 将下载的模型文件放入model目录
# model/Tencent_AILab_ChineseEmbedding.bin
# model/Tencent_AILab_ChineseEmbedding.bin.vectors.npy
```

### **5. 准备原始数据**

#### **5.1 商品数据**
- **文件**: `data/product.txt`
- **格式**: 商品信息文本文件
- **大小**: 约10MB

#### **5.2 商品分类数据**
- **文件**: `data/productType.json`
- **格式**: JSON格式的分类信息
- **大小**: 约8KB

### **6. 配置环境变量**

#### **6.1 复制环境变量模板**
```bash
cp env.example .env
```

#### **6.2 编辑环境变量**
```bash
# 编辑.env文件，配置数据库连接等
vim .env
```

**关键配置项**:
```env
# 数据库配置
DATABASE_URL=postgresql://$(whoami)@localhost:5432/recommendation_db

# 模型路径
VECTOR_MODEL_PATH=../model/Tencent_AILab_ChineseEmbedding.bin

# 数据路径
PRODUCT_DATA_PATH=../data/product.txt
PRODUCT_TYPE_PATH=../data/productType.json
```

### **7. 启动系统**

#### **7.1 启动后端服务**
```bash
# 进入后端目录
cd backend

# 启动Flask应用
python run.py
```

#### **7.2 启动前端服务**
```bash
# 新开终端，进入前端目录
cd frontend

# 启动开发服务器
npm run dev
```

### **8. 验证系统**

#### **8.1 检查服务状态**
```bash
# 检查后端服务 (端口5002)
curl http://localhost:5002/api/v1/health

# 检查前端服务 (端口3000)
curl http://localhost:3000
```

#### **8.2 测试核心功能**
```bash
# 测试商品搜索
curl "http://localhost:5002/api/v1/search/products?q=手机&limit=5"

# 测试相似商品查询
curl "http://localhost:5002/api/v1/similar-products/1?limit=5"
```

## 📊 还原后数据验证

### **数据库验证**
```sql
-- 连接数据库
psql -h localhost -U $(whoami) -d recommendation_db

-- 检查表数量
\dt

-- 检查商品数量
SELECT COUNT(*) FROM products;

-- 检查向量数据
SELECT COUNT(*) FROM products WHERE product_vector IS NOT NULL;
```

### **模型验证**
```python
# 测试词向量模型加载
python -c "
from app.services.recommendation_service import RecommendationService
service = RecommendationService()
print('模型加载成功' if service.word_vectors else '模型加载失败')
"
```

## 🔧 常见问题解决

### **问题1: 数据库连接失败**
```bash
# 检查PostgreSQL服务状态
brew services list | grep postgresql

# 重启PostgreSQL服务
brew services restart postgresql
```

### **问题2: 模型文件加载失败**
- 确认模型文件路径正确
- 检查文件权限
- 验证模型文件完整性

### **问题3: 前端依赖安装失败**
```bash
# 清理缓存重新安装
rm -rf node_modules package-lock.json
npm install
```

### **问题4: 端口占用**
```bash
# 检查端口占用
lsof -i :5002  # 后端端口
lsof -i :3000  # 前端端口

# 终止占用进程
kill -9 <PID>
```

## 📝 还原检查清单

- [ ] 代码仓库克隆完成
- [ ] Python依赖安装完成
- [ ] Node.js依赖安装完成
- [ ] PostgreSQL和pgvector安装完成
- [ ] 数据库创建完成
- [ ] 数据库还原完成
- [ ] 词向量模型下载完成
- [ ] 原始数据准备完成
- [ ] 环境变量配置完成
- [ ] 后端服务启动成功
- [ ] 前端服务启动成功
- [ ] 核心功能测试通过

## 🎯 还原完成标志

系统还原成功的标志：
- ✅ 后端API响应正常
- ✅ 前端页面加载正常
- ✅ 商品搜索功能正常
- ✅ 相似商品查询正常
- ✅ 数据库查询正常
- ✅ 词向量模型加载正常

## 📞 技术支持

如果在还原过程中遇到问题，请检查：
1. 系统日志文件 (`backend.log`, `frontend.log`)
2. 数据库连接配置
3. 模型文件路径和权限
4. 网络连接状态
5. 系统资源使用情况
