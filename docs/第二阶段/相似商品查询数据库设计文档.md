# 相似商品查询数据库设计文档

## 文档信息
- **项目名称**: 智能推荐系统
- **模块名称**: 相似商品查询
- **文档版本**: v1.0
- **创建日期**: 2024年12月20日
- **最后更新**: 2024年12月20日

## 1. 设计概述

### 1.1 设计目标
为相似商品查询功能设计高效、可扩展的数据库结构，支持：
- 商品向量存储和相似度计算
- 快速相似商品查询
- 用户行为数据收集
- 推荐算法优化

### 1.2 技术选型
- **数据库**: PostgreSQL 12+
- **向量扩展**: pgvector
- **索引策略**: 向量索引 + B-tree索引
- **缓存策略**: Redis缓存热点数据

## 2. 数据模型设计

### 2.1 核心表结构

#### 2.1.1 商品表 (products)
```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    image_url VARCHAR(500),
    category_id INTEGER,
    brand VARCHAR(100),
    tags TEXT[], -- 商品标签数组
    features JSONB, -- 商品特征JSON
    vector_embedding VECTOR(384), -- 商品向量嵌入
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.2 商品分类表 (categories)
```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INTEGER,
    description TEXT,
    level INTEGER DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.3 商品相似度表 (product_similarities)
```sql
CREATE TABLE product_similarities (
    id SERIAL PRIMARY KEY,
    product_id INTEGER NOT NULL,
    similar_product_id INTEGER NOT NULL,
    similarity_score DECIMAL(5,4) NOT NULL, -- 相似度分数 0-1
    algorithm_version VARCHAR(20) DEFAULT 'v1.0',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(product_id, similar_product_id)
);
```

#### 2.1.4 用户行为表 (user_behaviors)
```sql
CREATE TABLE user_behaviors (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    product_id INTEGER NOT NULL,
    behavior_type VARCHAR(20) NOT NULL, -- view, click, like, purchase
    session_id VARCHAR(100),
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.1.5 相似商品查询日志表 (similarity_query_logs)
```sql
CREATE TABLE similarity_query_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    query_product_id INTEGER NOT NULL,
    result_count INTEGER DEFAULT 0,
    response_time_ms INTEGER,
    algorithm_version VARCHAR(20),
    query_params JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.2 索引设计

#### 2.2.1 商品表索引
```sql
-- 商品向量索引 (pgvector)
CREATE INDEX idx_products_vector ON products USING ivfflat (vector_embedding vector_cosine_ops);

-- 商品分类索引
CREATE INDEX idx_products_category ON products(category_id);

-- 商品状态索引
CREATE INDEX idx_products_status ON products(status);

-- 商品名称索引
CREATE INDEX idx_products_name ON products USING gin(to_tsvector('chinese', name));

-- 商品标签索引
CREATE INDEX idx_products_tags ON products USING gin(tags);

-- 复合索引：分类+状态
CREATE INDEX idx_products_category_status ON products(category_id, status);
```

#### 2.2.2 相似度表索引
```sql
-- 商品相似度查询索引
CREATE INDEX idx_similarities_product ON product_similarities(product_id);

-- 相似度分数索引
CREATE INDEX idx_similarities_score ON product_similarities(similarity_score DESC);

-- 复合索引：商品+分数
CREATE INDEX idx_similarities_product_score ON product_similarities(product_id, similarity_score DESC);
```

#### 2.2.3 用户行为表索引
```sql
-- 用户行为查询索引
CREATE INDEX idx_behaviors_user ON user_behaviors(user_id);

-- 商品行为索引
CREATE INDEX idx_behaviors_product ON user_behaviors(product_id);

-- 行为类型索引
CREATE INDEX idx_behaviors_type ON user_behaviors(behavior_type);

-- 时间索引
CREATE INDEX idx_behaviors_created_at ON user_behaviors(created_at);

-- 复合索引：用户+时间
CREATE INDEX idx_behaviors_user_time ON user_behaviors(user_id, created_at DESC);
```

### 2.3 视图设计

#### 2.3.1 商品相似度视图
```sql
CREATE VIEW v_product_similarities AS
SELECT 
    p1.id as product_id,
    p1.name as product_name,
    p1.price as product_price,
    p1.image_url as product_image,
    p2.id as similar_product_id,
    p2.name as similar_product_name,
    p2.price as similar_product_price,
    p2.image_url as similar_product_image,
    ps.similarity_score,
    ps.algorithm_version,
    ps.updated_at
FROM products p1
JOIN product_similarities ps ON p1.id = ps.product_id
JOIN products p2 ON ps.similar_product_id = p2.id
WHERE p1.status = 'active' AND p2.status = 'active';
```

#### 2.3.2 用户偏好视图
```sql
CREATE VIEW v_user_preferences AS
SELECT 
    user_id,
    product_id,
    COUNT(*) as view_count,
    COUNT(CASE WHEN behavior_type = 'click' THEN 1 END) as click_count,
    COUNT(CASE WHEN behavior_type = 'like' THEN 1 END) as like_count,
    COUNT(CASE WHEN behavior_type = 'purchase' THEN 1 END) as purchase_count,
    MAX(created_at) as last_interaction
FROM user_behaviors
WHERE user_id IS NOT NULL
GROUP BY user_id, product_id;
```

## 3. 数据存储策略

### 3.1 向量存储
- **向量维度**: 384维 (基于中文文本嵌入模型)
- **存储格式**: pgvector VECTOR类型
- **索引类型**: IVFFlat索引，支持余弦相似度计算
- **更新策略**: 商品信息变更时重新计算向量

### 3.2 相似度预计算
- **计算策略**: 批量预计算商品相似度
- **存储方式**: 存储top-N相似商品 (N=50)
- **更新频率**: 每日增量更新
- **清理策略**: 定期清理低相似度记录

### 3.3 缓存策略
- **热点数据**: Redis缓存热门商品相似度
- **缓存时间**: 相似度数据缓存1小时
- **缓存键**: `similar_products:{product_id}`
- **缓存更新**: 商品信息变更时清除相关缓存

## 4. 查询优化

### 4.1 相似度查询优化
```sql
-- 优化后的相似商品查询
SELECT 
    p.id,
    p.name,
    p.price,
    p.image_url,
    (1 - (p.vector_embedding <=> target.vector_embedding)) as similarity_score
FROM products p
CROSS JOIN (
    SELECT vector_embedding 
    FROM products 
    WHERE id = $1
) target
WHERE p.id != $1 
  AND p.status = 'active'
  AND (1 - (p.vector_embedding <=> target.vector_embedding)) > 0.75
ORDER BY p.vector_embedding <=> target.vector_embedding
LIMIT 12;
```

### 4.2 预计算查询
```sql
-- 使用预计算相似度表查询
SELECT 
    similar_product_id,
    similarity_score,
    p.name,
    p.price,
    p.image_url
FROM product_similarities ps
JOIN products p ON ps.similar_product_id = p.id
WHERE ps.product_id = $1
  AND p.status = 'active'
ORDER BY ps.similarity_score DESC
LIMIT 12;
```

### 4.3 个性化查询
```sql
-- 结合用户行为的个性化查询
WITH user_preferences AS (
    SELECT product_id, COUNT(*) as preference_score
    FROM user_behaviors
    WHERE user_id = $1 AND behavior_type IN ('click', 'like', 'purchase')
    GROUP BY product_id
)
SELECT 
    ps.similar_product_id,
    ps.similarity_score,
    COALESCE(up.preference_score, 0) as user_preference,
    p.name,
    p.price,
    p.image_url
FROM product_similarities ps
JOIN products p ON ps.similar_product_id = p.id
LEFT JOIN user_preferences up ON ps.similar_product_id = up.product_id
WHERE ps.product_id = $2
  AND p.status = 'active'
ORDER BY (ps.similarity_score * 0.7 + COALESCE(up.preference_score, 0) * 0.3) DESC
LIMIT 12;
```

## 5. 数据维护

### 5.1 数据清理
```sql
-- 清理低相似度记录
DELETE FROM product_similarities 
WHERE similarity_score < 0.75;

-- 清理过期行为数据
DELETE FROM user_behaviors 
WHERE created_at < CURRENT_TIMESTAMP - INTERVAL '1 year';

-- 清理无效查询日志
DELETE FROM similarity_query_logs 
WHERE created_at < CURRENT_TIMESTAMP - INTERVAL '3 months';
```

### 5.2 数据统计
```sql
-- 商品相似度统计
SELECT 
    COUNT(*) as total_similarities,
    AVG(similarity_score) as avg_similarity,
    MIN(similarity_score) as min_similarity,
    MAX(similarity_score) as max_similarity
FROM product_similarities;

-- 查询性能统计
SELECT 
    DATE(created_at) as query_date,
    COUNT(*) as query_count,
    AVG(response_time_ms) as avg_response_time,
    MAX(response_time_ms) as max_response_time
FROM similarity_query_logs
GROUP BY DATE(created_at)
ORDER BY query_date DESC;
```

## 6. 性能监控

### 6.1 关键指标
- **查询响应时间**: 平均响应时间 < 2秒
- **相似度计算准确率**: > 80%
- **数据库连接数**: 监控并发连接
- **索引使用率**: 监控索引效率

### 6.2 监控查询
```sql
-- 慢查询监控
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements
WHERE mean_time > 1000 -- 超过1秒的查询
ORDER BY mean_time DESC;

-- 索引使用统计
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

## 7. 备份策略

### 7.1 备份计划
- **全量备份**: 每日凌晨2点
- **增量备份**: 每4小时一次
- **日志备份**: 实时备份WAL日志
- **保留策略**: 全量备份保留30天，增量备份保留7天

### 7.2 恢复测试
- **恢复测试**: 每月进行一次恢复测试
- **恢复时间**: 目标恢复时间 < 4小时
- **数据完整性**: 验证数据完整性

## 8. 扩展性考虑

### 8.1 水平扩展
- **分片策略**: 按商品ID进行分片
- **读写分离**: 主从复制，读操作分离
- **连接池**: 使用PgBouncer管理连接

### 8.2 垂直扩展
- **硬件升级**: CPU、内存、存储升级
- **参数调优**: PostgreSQL参数优化
- **索引优化**: 定期分析和优化索引

## 9. 安全考虑

### 9.1 数据安全
- **访问控制**: 严格的数据库用户权限管理
- **数据加密**: 敏感数据加密存储
- **审计日志**: 记录所有数据库操作

### 9.2 备份安全
- **备份加密**: 备份文件加密存储
- **异地备份**: 备份文件异地存储
- **访问控制**: 备份文件访问权限控制

## 10. 附录

### 10.1 相关脚本
- 数据库初始化脚本
- 索引创建脚本
- 数据迁移脚本
- 性能测试脚本

### 10.2 参考文档
- PostgreSQL官方文档
- pgvector扩展文档
- 数据库性能优化指南
- 向量数据库最佳实践
